#! /usr/bin/ruby

#   Copyright 2012 Red Hat, Inc.
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.

require 'yaml'

NODE_DIR='/etc/aeolus-configure/nodes'
profile_file = File.join(NODE_DIR, ARGV[0])
common_file = case
              when ARGV[0].end_with?('_configure')
                File.join(NODE_DIR, 'common_configure')
              when ARGV[0].end_with?('_cleanup')
                File.join(NODE_DIR, 'common_cleanup')
              else
                STDERR.puts "Unknown profile type for #{ARGV[0]}, " \
                            "should be one of {configure,cleanup}"
                exit!(1)
              end

[common_file, profile_file].each do |f|
  unless File.exists?(f)
    STDERR.puts "No such file or directory - #{f}"
    exit!(1)
  end
end

begin
  common_params = YAML::load_file(common_file)['parameters']
  profile = YAML::load_file(profile_file)
rescue => e
  STDERR.puts e.message
  exit!(1)
end

profile['parameters'] ||= {}
profile['parameters'] = common_params.merge(profile['parameters'])
puts YAML::dump(profile)


